\documentclass[11pt]{amsart}          
\usepackage{amsfonts}
\usepackage{amssymb}  
\usepackage{amsthm} 
\usepackage{amsmath} 
\usepackage{tikz-cd}
\usepackage{float}
\usepackage[]{hyperref}
\usepackage{minted}
\hypersetup{
  colorlinks,
  linkcolor=blue,
  citecolor=blue,
  urlcolor=blue}
\newcommand{\hask}[1]{\mintinline{Haskell}{#1}}
\newenvironment{haskell}
  {\VerbatimEnvironment
  	\begin{minted}[escapeinside=??, mathescape=true,frame=single, framesep=5pt, tabsize=1]{Haskell}}
  {\end{minted}}
\newcommand{\cat}[1]{\mathcal{#1}}%a generic category
\newcommand{\Cat}[1]{\mathbf{#1}}%a named category
\newcommand{\Set}{\Cat{Set}}

\author{Bartosz Milewski}
\title{Presheaf Optics}
\begin{document}
\maketitle{}

\section{Motivation}

A lot of optics can be defined using the existential, or coend, representation:
\[ \mathcal{O}\langle a, b\rangle \langle s, t \rangle = \int^{m \colon \cat M} \cat C (s, m \bullet a) \times \cat D ( m \bullet b, t) \]
Here $\cat M$ is a monoidal category with an action on objects of two categories $\cat C$ and $\cat D$ (I'll use the same notation for both actions).

The idea is that we have a pair of morphisms, one decomposing the source $s$ into the action of some $m$ on $a$, and the other recomposing the target $t$ from the action of the same $m$ on $b$. In most applications we pick $\cat D$ to be the same category as $\cat C$.

Recently, there has been renewed interest in polynomial functors. Morphisms between polynomial functors form a new kind of optics that doesn't neatly fit this mold. They do, however, admit an existential representation or the form:
\[ \int^{c_{k i}} 
 \prod_{k \in K} \mathbf{Set} \left(s_k,  \sum_{n \in N} a_n \times c_{n k} \right) \times 
 \prod_{i \in K}  \mathbf{Set} \left(\sum_{m \in N} b_m \times c_{m i}, t_i \right) \]
Here the sets $s_k$ and $t_i$ can be treated as fibers over the set $K$, while the sets $a_n$ and $b_m$ are fibers over a different set $N$. 

We can treat these fibrations as functors from discrete categories to $\Set$, that is co-presheaves. For instance $a_n$ is the result of a co-presheaf $a$ acting on an object $n$ of a discrete category $\cat N$. The products over $K$ can be interpreted as ends that define natural transformations between co-presheaves. The problem is that the matrices $c_{n k}$ are fibrated over two different sets. I have previously interpreted them as profunctors:
\[ c \colon \cat N^{op} \times \cat K \to \Set \]
In this post I will elaborate on this interpretation.

\section{Co-presheaves}

A co-presheaf category  $[\cat C, Set ]$ behaves, in many respects, like a vector space. For instance, it has a ``basis'' consisting of representable functors $\cat C (r, -)$; in the sense that any co-presheaf is as a colimit of representables. Moreover, colimit-preserving functors between co-presheaf categories are very similar to linear transformations between vector spaces. Of particular interest are functors that are left adjoint to some other functors, since left adjoints preserve colimits. 

The polynomial lens formula has a form that suggests vector-space interpretation. We have one vector space with vectors $\vec{s}$ and $\vec{t}$ and another with $\vec{a}$ and $\vec{b}$. Rectangular matrices $c_{n k}$ can be seen as components of a linear transformation between these two vector spaces. We can, for instance, write:
\[  \sum_{n \in N} a_n \times c_{n k} = c^T a \]
where $c^T$ is the transposed matrix. Transposition can be interpreted as the analog of an adjunction. 

We can now re-interpret the polynomial lens formula in terms of co-presheaves. We no longer intepret $\cat N$ and $\cat K$ as discrete categories. We have:
\[ s, t \colon [\cat K, \Set] \]
\[a, b \colon [\cat N, \Set] \]
In this interpretation $c$ is a functor:
\[ c \colon [\cat N, \Set] \to [\cat K, \Set] \]
We'll write the action of this functor on a presheaf $a$ as $c \bullet a$.

We assume that this functor is a left adjoint and therefore preserves colimits. 

\[ [\cat K, \Set] (c \bullet a, t) \cong [\cat N, \Set] (a, c^{\dagger} \bullet t) \]
where:
\[ c^{\dagger} \colon [\cat K, \Set] \to [\cat N, \Set] \]

We can now generalize the polynomial optic formula to:
\[ \mathcal{O}\langle a, b\rangle \langle s, t \rangle = \int^{c} 
 [\cat K, \Set] \left(s,  c \bullet a \right) \times 
 [\cat K, \Set] \left(c \bullet b, t \right) \]
The coend is taken over all functors that have a right adjoint. Fortunately there is a better representation. It turns out that left adjoint functors:
\[ c \colon [\cat N, \Set] \to [\cat K, \Set] \]
are equivalent to profunctors (see the Appendix for the proof):
\[ p \colon \cat N^{op} \times \cat K \to \Set \]
given by the formula:
\[p \langle n, k \rangle = c ( \cat N(n, -)) k \]
where $\cat N(n, -)$ is a representable co-presheaf.

The action of $c$ can be expressed as a coend:
\[ (c \bullet a) k = \int^{n} a(n) \times p \langle n, k \rangle \]
The co-presheaf optic is then a coend over all profunctors $p \colon \cat N^{op} \times \cat K \to \Set$:
\[ \int^{p} 
 [\cat K, \Set] \left(s,  \int^{n} a(n) \times p \langle n, - \rangle \right) \times 
 [\cat K, \Set] \left(\int^{n'} b(n') \times p \langle n', - \rangle, t \right) \]
 
 \section{Composition}

The composition of two functors:
\[ c \colon  [\cat N, \Set] \to [\cat K, \Set] \]
and:
\[ c' \colon  [\cat K, \Set] \to [\cat M, \Set] \]
is equivalent to profunctor composition. Indeed, the profunctor $p' \diamond p$ corresponding to $c' \circ c$ is given by:
\[(p' \diamond p) \langle n, m \rangle = (c' \circ c) ( \cat N(n, -)) m \]

\[(c' ( c ( \cat N(n, -))) m 
 \cong \int^{k} c ( \cat N(n, -)) k \times p' \langle k, m \rangle \]
\[  \cong \int^{k} p \langle n, k \rangle \times p' \langle k, m \rangle \]
which is the standard definition of profunctor composition. 

Consider two composable co-presheaf optics, $\mathcal{O}\langle a, b\rangle \langle s, t \rangle$ and $\mathcal{O}\langle a', b' \rangle \langle a, b \rangle$. Let's write:
\[ \mathcal{O}\langle a, b\rangle \langle s, t \rangle = \int^{c}  l_c (s,  a ) \times r_c (b, t) \]
 where:
\[ l_c (s,  a ) = [\cat K, \Set] \left(s,  c \bullet a \right) \] 
\[ r_c (b, t) = [\cat K, \Set] \left(c \bullet b, t \right) \]
and similarly for the second optic.


Since functors between co-presheaves can be composed
\[ \mathcal{O}\langle a, b\rangle \langle s, t \rangle = \int^{c} 
 [\cat K, \Set] \left(s,  c \bullet a \right) \times 
 [\cat K, \Set] \left(c \bullet b, t \right) \]


\section{Appendix}

I will show that a functor between two co-presheaves that has a right adjoint and therefore preserves colimits:
\[ c \colon [\cat N, \Set] \to [\cat K, \Set] \]
is equivalent to a profunctor:
\[p \colon \cat N^{op} \times \cat K \to \Set \]

The profunctor is given by:
\[p \langle n, k \rangle = c ( \cat N(n, -)) k \]
and the functor $c$ can be recovered using the formula:
\[ c (a) k = \int^{n'} a (n') \times p \langle n', k \rangle \]
where:
\[ a \colon [\cat N, \Set] \]

I'll show that these formulas are the inverse of each other. First, inserting the formula for $c$ in the definition of $p$ should gives us $p$ back:
\[  \int^{n'} \cat N(n, -) (n') \times p\langle n', k \rangle \cong  p \langle n, k \rangle \]
which follows from the co-Yoneda lemma.

Second, inserting the formula for $p$ into the definition of $c$ should give us $c$ back:
\[  \int^{n'} a n' \times c(\cat N(n', -)) k  \cong c (a) k  \]
Since $c$ preserves all colimits, and any co-presheaf is a colimit of representables, it's enough that we prove this identity for a representable:
\[ a (n) = \cat N (r, n) \]
We want to show that:
\[ \int^{n'}  \cat N (r, n')  \times  c(\cat N(n', -)) k \cong  c ( \cat N (r, -) ) k\]
This follows from the co-Yoneda lemma.

\end{document}